name: Build Dev Docker Image

on:
  push:
    branches:
      - dev

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v6

      - name: Get short SHA
        id: get_sha
        run: echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev-${{ env.SHORT_SHA }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

      - name: Image details
        run: |
          echo "Docker image built and pushed successfully!"
          echo "Image tags:"
          echo "  - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev"
          echo "  - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev-${{ env.SHORT_SHA }}"
          echo ""
          echo "Frontend team can pull and run with:"
          echo "  docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev"
          echo "  docker run -p 8000:8000 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev"

      - name: Send Discord notification (Success)
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üî® Dev Docker Image Built",
                "description": "New development backend image available for frontend team. Mind restarting your stack !",
                "color": 3447003,
                "fields": [
                  {
                    "name": "Branch",
                    "value": "'"${{ github.ref_name }}"'",
                    "inline": true
                  },
                  {
                    "name": "Commit",
                    "value": "'"${{ env.SHORT_SHA }}"'",
                    "inline": true
                  },
                  {
                    "name": "Image Tags",
                    "value": "`dev` | `dev-'"${{ env.SHORT_SHA }}"'`"
                  },
                  {
                    "name": "Pull Command",
                    "value": "`docker pull '"${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev"'`"
                  },
                  {
                    "name": "Links",
                    "value": "[Commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }}) | [Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
                  }
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'",
                "footer": {
                  "text": "Together API Development"
                }
              }]
            }' \
            "$DISCORD_WEBHOOK"

      - name: Send Discord notification (Failure)
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "‚ùå Dev Image Build Failed",
                "description": "Failed to build development Docker image. Oopsi...",
                "color": 15158332,
                "fields": [
                  {
                    "name": "Branch",
                    "value": "'"${{ github.ref_name }}"'",
                    "inline": true
                  },
                  {
                    "name": "Commit",
                    "value": "'"${{ env.SHORT_SHA }}"'",
                    "inline": true
                  },
                  {
                    "name": "Action Required",
                    "value": "Check [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details"
                  }
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'",
                "footer": {
                  "text": "Together API Development"
                }
              }]
            }' \
            "$DISCORD_WEBHOOK"
