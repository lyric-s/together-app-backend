name: Bump version

on:
  push:
    branches:
      - main

jobs:
  bump_version:
    if: "!startsWith(github.event.head_commit.message, 'bump:')"
    name: "Bump version and create changelog with commitizen"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Check out
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: "${{ secrets.GITHUB_TOKEN }}"

      - id: cz
        name: Create bump and changelog
        uses: commitizen-tools/commitizen-action@0.25.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          push: true
          commit: true
          changelog: true

      - name: Print Version
        run: echo "Bumped to version ${{ steps.cz.outputs.version }}"

      - name: Create GitHub Release
        if: steps.cz.outputs.version != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract changelog section for this version
          VERSION="${{ steps.cz.outputs.version }}"

          # Create release with changelog
          gh release create "v$VERSION" \
            --title "Release v$VERSION" \
            --notes "See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details." \
            --latest

      - name: Create Release Summary
        if: steps.cz.outputs.version != ''
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸŽ‰ Version Bumped

          **New Version:** \`${{ steps.cz.outputs.version }}\`

          ### What's Next

          1. ðŸ·ï¸ GitHub Release created: [v${{ steps.cz.outputs.version }}](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.cz.outputs.version }})
          2. ðŸš€ Production deployment will trigger automatically
          3. ðŸ“ CHANGELOG.md has been updated

          ### Deployment Pipeline

          The production deployment workflow will now:
          - Build Docker image with semantic version tags
          - Push to GitHub Container Registry
          - Deploy to production via Coolify
          - Run health checks
          - Send Discord notification

          ---

          _Generated by Commitizen_
          EOF

      - name: Send Discord notification
        if: steps.cz.outputs.version != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "ðŸŽ‰ New Version Released",
                "description": "A new version has been released and will be deployed to production",
                "color": 5814783,
                "fields": [
                  {
                    "name": "Version",
                    "value": "v${{ steps.cz.outputs.version }}",
                    "inline": true
                  },
                  {
                    "name": "Commit",
                    "value": "[`${{ github.sha }}...`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})",
                    "inline": true
                  },
                  {
                    "name": "Links",
                    "value": "[Release](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.cz.outputs.version }}) | [Changelog](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)"
                  }
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'",
                "footer": {
                  "text": "Together API Release"
                }
              }]
            }' \
            "$DISCORD_WEBHOOK" || echo "Discord notification failed (non-critical)"
